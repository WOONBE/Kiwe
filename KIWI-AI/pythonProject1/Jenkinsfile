pipeline {
    agent any
    environment {
        KIWI_ENV = credentials('jenkins_kiwi_ai.env') // secretfile ê°€ì ¸ì˜¤ê¸°
    }
    stages {
        stage('Load Environment Variables') {
            steps {
                script {
                    // jenkins_kiwi_ai.env íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
                    def props = readProperties(file: env.KIWI_ENV)
                    env.DOCKER_IMAGE = props['DOCKER_IMAGE']
                    env.DOCKER_IMAGE_FILE = props['DOCKER_IMAGE_FILE']
                    env.DEPLOY_LOG_PATH = props['DEPLOY_LOG_PATH']
                    env.MATTERMOST_CHANNEL_NAME = props['MATTERMOST_CHANNEL_NAME']
                    env.MATTERMOST_WEBHOOK_URL = props['MATTERMOST_WEBHOOK_URL']
                    env.REMOTE_DIR = props['REMOTE_DIR']  // ì˜¬ë°”ë¥¸ ê²½ë¡œ í™•ì¸
                }
            }
        }
                stage('Notify Build Start') {
            steps {
                script {
                    def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                    def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                    def Commit_Message = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()

                    // ì´ì „ ì»¤ë°‹ì„ í™•ì¸í•˜ê³  ê¸°ë³¸ê°’ì„ ì„¤ì •
                    def previousCommit = env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD'
                    def allCommits = sh(script: "git log --pretty=format:'%h - %s (%an)' ${previousCommit}..HEAD", returnStdout: true).trim()

                    // ì»¤ë°‹ ë©”ì‹œì§€ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    def formattedCommits = allCommits.split('\n').collect { line ->
                        // ì´ìŠ¤ì¼€ì´í”„ ë¬¸ìë¥¼ ì œëŒ€ë¡œ ì²˜ë¦¬í•˜ê³ , í•„ìš”ì—†ëŠ” ì´ìŠ¤ì¼€ì´í”„ ë¬¸ìëŠ” ì œê±°
                        def escapedLine = line.replaceAll("([\\[\\]\\(\\)])", '\\\\$1') // ê´„í˜¸ë‚˜ ëŒ€ê´„í˜¸ëŠ” ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                        "â€¢ ${escapedLine}"
                    }.join('\n')  // ì‹¤ì œ ì¤„ë°”ê¿ˆì„ ì‚¬ìš©

                    def message = """
                        #### ğŸŒBE ë¹Œë“œ ì‹œì‘
                        **ë¹Œë“œ ë²ˆí˜¸:** $env.JOB_NAME #$env.BUILD_NUMBER
                        **ë¸Œëœì¹˜:** $env.GIT_BRANCH
                        **ì‘ì„±ì:** $Author_ID ($Author_Name)
                        **ë¹Œë“œ URL:** [Details]($env.BUILD_URL)
                        **í¬í•¨ëœ ì»¤ë°‹:**
                        $formattedCommits
                    """.stripIndent()

                    mattermostSend(
                        color: '#439FE0',
                        message: message,
                        endpoint: "$MATTERMOST_WEBHOOK_URL",
                        channel: "$MATTERMOST_CHANNEL_NAME",
                        icon: 'https://jenkins.io/images/logos/jenkins/jenkins.png'
                    )
                }
            }
        }
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì €ì¥
                    sh 'cd KIWI-AI/pythonProject1 && docker build -t $DOCKER_IMAGE .'
                    sh 'cd KIWI-AI/pythonProject1 && docker save $DOCKER_IMAGE -o $DOCKER_IMAGE_FILE'
                }
            }
        }

        stage('Transfer Files to EC2') {
            steps {
                script {
                    // ë‘ íŒŒì¼ì„ EC2ë¡œ ì „ì†¡í•˜ëŠ” ë‹¨ê³„
                    sshPublisher(
                        continueOnError: false, 
                        failOnError: true, 
                        publishers: [
                            sshPublisherDesc(
                                configName: 'D205-Server',
                                transfers: [
                                    sshTransfer(
                                        sourceFiles: "KIWI-AI/pythonProject1/$DOCKER_IMAGE_FILE", 
                                        removePrefix: 'KIWI-AI/pythonProject1', 
                                        remoteDirectory: env.REMOTE_DIR,
                                        execCommand: '''
                                            echo "Transferred $DOCKER_IMAGE_FILE to $REMOTE_DIR"
                                            pwd
                                            ls -al $REMOTE_DIR
                                        ''',
                                        execTimeout: 120000,
                                        verbose: true
                                    ),
                                    sshTransfer(
                                        sourceFiles: 'KIWI-AI/pythonProject1/compose.yml',
                                        removePrefix: 'KIWI-AI/pythonProject1',
                                        remoteDirectory: env.REMOTE_DIR,
                                        execCommand: '''
                                            echo "Transferred compose.yml to $REMOTE_DIR"
                                            pwd
                                            ls -al $REMOTE_DIR
                                        ''',
                                        execTimeout: 120000,
                                        verbose: true
                                    )
                                ]
                            )
                        ]
                    )
                }
            }
        }
        stage('Deploy FastApi Server') {
            steps {
                script {
                    sshPublisher(
                        publishers: [
                            sshPublisherDesc(
                                configName: 'D205-Server',
                                transfers: [
                                    sshTransfer(
                                        execCommand: """
                                            set -x  # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
                                            exec > >(tee $DEPLOY_LOG_PATH) 2>&1
                                            cd $REMOTE_DIR
                                            
                                            # ì´ë¯¸ì§€ ì¶”ì¶œ
                                            docker load -i $DOCKER_IMAGE_FILE
                                            
                                            # ê¸°ì¡´ FastAPI ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
                                            docker compose down
                                            
                                            # ìƒˆ ì´ë¯¸ì§€ë¡œ FastAPI ì„œë²„ ì‹œì‘
                                            docker compose up -d
                                        """
                                    )
                                ]
                            )
                        ]
                    )
                }
            }
        }
    }

    post {
        always {
            script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                def Commit_Message = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()
                def Build_Status = currentBuild.result ?: 'SUCCESS'
                def Status_Color = Build_Status == 'SUCCESS' ? 'good' : (Build_Status == 'UNSTABLE' ? 'warning' : 'danger')
                def Status_Text = Build_Status == 'SUCCESS' ? 'ë¹Œë“œ ì„±ê³µ' : (Build_Status == 'UNSTABLE' ? 'ë¹Œë“œ ë¶ˆì•ˆì •' : 'ë¹Œë“œ ì‹¤íŒ¨')

                def message = """
                    #### ğŸŒBE $Status_Text
                    **ë¹Œë“œ ë²ˆí˜¸** $env.JOB_NAME #$env.BUILD_NUMBER
                    **ì‘ì„±ì:** $Author_ID ($Author_Name)
                    **ë¹Œë“œ URL:** [Details]($env.BUILD_URL)
                """.stripIndent()
                mattermostSend(
                    color: Status_Color,
                    message: message,
                    endpoint: "$env.MATTERMOST_WEBHOOK_URL",
                    channel: "$env.MATTERMOST_CHANNEL_NAME",
                    icon: 'https://jenkins.io/images/logos/jenkins/jenkins.png'
                )
            }
            steps {
                cleanws()  // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ í´ë¦¬ë‹
            }
        }
    }
}
